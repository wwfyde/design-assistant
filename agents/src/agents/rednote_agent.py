from typing import NotRequired, Optional

from langchain.agents import AgentState, create_agent
from langchain.agents.middleware import AgentMiddleware, ModelRequest, dynamic_prompt
from langgraph.graph.state import CompiledStateGraph
from pydantic import BaseModel, Field
from tools.images import image_create_with_seedream

links = [
    (
        "å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆç”Ÿæˆå™¨ | ä¸€é”®ç”Ÿæˆçˆ†æ¬¾æ–‡æ¡ˆğŸ”¥",
        "https://xhsplus.io/cn/xiaohongshu-zhengwen",
    ),
]


class RednoteState(AgentState):
    """çŸ­æœŸè®°å¿†, ä¼šè¯çº§åˆ«"""

    aspect_ratio: NotRequired[str]
    preferences: Optional[dict]  # ç”¨æˆ·åå¥½, ç”¨äºæ›´æ–°ç”¨æˆ·ä¼šè¯çº§åˆ«çš„è®°å¿†
    with_figure: Optional[bool]
    with_tag: Optional[bool]


class ResponseFormat(BaseModel):
    content: str
    title: Optional[str] = Field(None, title="æ ‡é¢˜", description="æ ‡é¢˜")
    images: Optional[list[str]] = Field(None, title="ç”Ÿæˆçš„å›¾ç‰‡url", description="ç”Ÿæˆçš„å›¾ç‰‡URLåˆ—è¡¨")
    # preferences: Optional[dict]
    # tags: list[str]
    # with_emoji: bool = Field(
    #     False, title="åŒ…å«è¡¨æƒ…ç¬¦å·", description="å†…å®¹æ˜¯å¦åŒ…å«è¡¨æƒ…ç¬¦å·"
    # )


class RednoteContext(BaseModel):
    user_id: str
    # conversation_id: str = Field(title="å¯¹è¯ID")
    user_id: Optional[str] = Field(None, title="ç”¨æˆ·ID")
    session_id: Optional[str] = Field(None, title="ä¼šè¯ID")
    profile_id: Optional[str] = Field(None, title="ç”¨æˆ·èµ„æ–™ID")
    canvas_id: Optional[str] = Field(None, title="ç”»å¸ƒID", description="é¡¹ç›®ID")


class CustomMiddleware(AgentMiddleware):
    state_schema = RednoteState

    # def before_model(
    #     self, state: AgentState[RednoteState], runtime: Runtime[ResponseFormat]
    # ) -> dict[str, Any] | None:
    #     prefrences = state.get("preferences", None)
    #     if not prefrences:
    #         # TODO: æœªåˆå§‹åŒ–ç”¨æˆ·åå¥½
    #         pass
    #     pass


tags = [
    "æ¢åº—æ‰“å¡",
    "ç¾é£Ÿåˆ†äº«",
    "æ—…æ¸¸å‡ºè¡Œ",
    "çŸ¥è¯†æˆé•¿",
    "å¯çˆ±èŒå® ",
    "ç¾å¦†å¥½ç‰©",
    "æ—¶å°šç©¿æ­",
    "å¥èº«å¹²è´§",
    "æŠ¤è‚¤å¿ƒå¾—",
    "å•†å“æ¨è",
    "å®¶å±…å¥½ç‰©",
    "æ¯å©´åˆ†äº«",
    "æ­£èƒ½é‡ğŸ”¥",
    "ç§è‰æ–‡æ¡ˆ",
    "æµ‹è¯„æ–‡æ¡ˆ",
]

template_prompt = """
# æ¨¡ç‰ˆ

## æ¢åº—æ‰“å¡

ä¸»é¢˜ï¼šå—æ˜ŒåœŸè‘—æ¨èï¼Œç¾é£Ÿå…¨æ”»ç•¥ 
åº—åï¼šè€åœ°æ–¹å¥½å‘³åŠ 
æ¨èèœï¼šäº®äº®æ°´ç…®ã€èŸ¹è„šæç²‰ã€éº»è¾£è—•ç‰‡ã€æ‹›ç‰Œå•¤é…’é¸­ 
æ¨èç†ç”±ï¼šå¹³ä»·å¥½åƒä¸è¸©é›· 
åœ°å€ï¼šæ±Ÿè¥¿çœå—æ˜Œå¸‚ä¸­å±±è·¯ä¸‡å¯¿å®«å†å²æ–‡åŒ–è¡—åŒº

## ç¾é£Ÿåˆ†äº«
ä¸»é¢˜ï¼šä¸€å®šè¦è¯•è¯•è¿™é“èœ 
ç¾é£Ÿåç§°ï¼šå•¤é…’é¸­ 
å†…å®¹æ–¹å‘ï¼šèœè°±åŠåšæ³•åˆ†äº« 
ä¸»è¦å†…å®¹ï¼š 
æ‰€éœ€é£Ÿæï¼šé£Ÿæï¼šé¸­è‚‰ã€ç™½é…’ã€å•¤é…’ã€è‘±å§œè’œã€å…«è§’ã€æ¡‚çš®ã€é¦™å¶ã€é’çº¢æ¤’ 
åšæ³•ï¼š 
1.é¸­è‚‰æ´—å‡€åˆ‡å—ï¼Œç›´æ¥ä¸‹é”…ï¼ŒåŠ 5å‹ºç™½é…’ä¸€èµ·ç¿»ç‚’ï¼Œç‚’è‡³é¸­è‚‰æ°´åˆ†æ”¶å¹²å˜è‰²ï¼ŒåŠ è‘±å§œè’œã€é¦™æ–™ç¿»ç‚’å‡åŒ€ 
2.åŠ 1å‹ºè±†ç“£ç‚’å‡ºçº¢æ²¹ï¼Œç„¶ååŠ 2å‹ºç”ŸæŠ½ã€1å‹ºè€æŠ½ã€1å‹ºèšæ²¹ç¿»ç‚’å‡åŒ€ 
3.åŠ å…¥å•¤é…’å’Œæ¸…æ°´ï¼Œå¤§ç«ç…®æ²¸åè½¬ä¸­å°ç«ï¼Œç„–ç…®40åˆ†é’Ÿï¼Œæœ€ååŠ é’çº¢æ¤’ï¼Œå¤§ç«æ”¶æ±

## æ—…æ¸¸å‡ºè¡Œ
ä¸»é¢˜ï¼šé˜¿é‚£äºšä¸¤å¤©ä¸€æ™šè¶…è¯¦ç»†æ”»ç•¥ 
åœ°ç‚¹åç§°ï¼šé˜¿é‚£äºš 
å†…å®¹æ–¹å‘ï¼šæ”»ç•¥åˆ†äº« 
å…³é”®ä¿¡æ¯ï¼š 
1. äº¤é€šï¼šåŒ—äº¬ç«™â†’åŒ—æˆ´æ²³ç«™ï¼ˆ2h10ï¼‰ 
2. æ¸¸ç©è·¯çº¿ï¼šDay1:çŠ¬èˆâ†’æµ·è¾¹éŸ³ä¹å…â†’Tagi.â†’ç¤¼å ‚â†’å­¤ç‹¬å›¾ä¹¦é¦† 
3. Day2:ç¤¼å ‚çœ‹æ—¥å‡ºâ†’å­¤ç‹¬å›¾ä¹¦é¦†â†’é—²é€› 
4. åƒé¥­ï¼šåƒè¿‡ä¸‰ã€å››ã€å…­é£Ÿå ‚ï¼Œæ„Ÿè§‰å…­é£Ÿå ‚çš„é¢å¾ˆå¥½åƒ 
5. ä½å®¿ï¼šç›´æ¥åœ¨ç¬¬ä¸‰æ–¹å¹³å°é¢„å®šå°±å¯ä»¥

## çŸ¥è¯†å¹²è´§
ä¸»é¢˜ï¼šé«˜æ•ˆé˜…è¯»æ–¹æ³•â€”å¦‚ä½•è¯»é€ä¸€æœ¬ä¹¦ 
å¿ƒå¾—/å¹²è´§åˆ†äº«ï¼š 
1.ç»™è‡ªå·±æ­£é¢åé¦ˆ  
2.è¯»ä¹¦è¿‡ç¨‹ä¸­åŠæ—¶è®°å½•å‹¾ç”»  
3.è¾¹è¯»è¾¹åšç¬”è®°ï¼ŒåŠæ—¶è®°å¿†é¿å…é—å¿˜  
4.é‡æ„çŸ¥è¯†ç‚¹å¹¶è¾“å‡º

## å¯çˆ±èŒå® 
ä¸»é¢˜ï¼šæ–°æ‰‹å…»çŒ«æ”»ç•¥ 
å® ç‰©ç±»å‹ï¼šå°çŒ« 
è§‚ç‚¹æè¿°ï¼šæ–°æ‰‹å…»çŒ«ä¸€å®šè¦æ³¨æ„å°çª—ï¼

## ç¾å¦†å¥½ç‰©
ä¸»é¢˜ï¼šé»„çš®æ˜¾ç™½å£çº¢æ¨è 
å¥½ç‰©åç§°ï¼šYSLå°é»‘æ¡314å£çº¢ 
å†…å®¹æ–¹å‘ï¼šå¥½ç‰©ç§è‰ 
æ¨èç†ç”±ï¼šé»„çš®ç´ é¢œææ°”è‰²ï¼Œæ—¥å¸¸ä¸è¸©é›·ï¼Œä½é¥±å’Œåº¦æ˜¾å¾—çš®è‚¤æœ‰è´¨æ„Ÿ

## æ—¶å°šç©¿æ­

ä¸»é¢˜ï¼šæ—¥å¸¸â€œè€é’±é£â€æ€ä¹ˆç©¿ï¼Ÿè¿™ä¹ˆç©¿æ°”è´¨åˆé«˜çº§ï¼ 
å¥½ç‰©åç§°ï¼šAå­—ç›´ç­’é•¿æ¬¾åŠèº«è£™ 
æ¨èç†ç”±ï¼šæ€ä¹ˆç©¿éƒ½å¥½çœ‹ï¼Œç™¾æ­èˆ’é€‚ï¼Œç®€çº¦æ—¶é«¦ï¼Œè‡ªå¸¦æ¾å¼›æ„Ÿ

## å¥èº«å¹²è´§
ä¸»é¢˜ï¼šè®°ä½è¿™16ç§é£Ÿç‰©ï¼Œè½»æ¾å‡æ‰20æ–¤ 
å¹²è´§å†…å®¹ï¼š 
8åƒ8ä¸åƒï¼š 
8åƒï¼šç”œç‰ç±³ã€æ°´ç…®è›‹ã€ç‡•éº¦ç‰‡ã€é¦’å¤´ã€é»‘å’–å•¡ã€å¥‡äºšç±½ã€è‹¹æœã€çŒ•çŒ´æ¡ƒã€ 
8ä¸åƒï¼šç³¯ç‰ç±³ã€é¢åŒ…ã€å„ç§ç²¥ã€æ°´ç…®èœã€ç”œç”œåœˆã€éº»çƒã€æ¦´è²ã€ç“œå­

## æŠ¤è‚¤å¿ƒå¾—
ä¸»é¢˜ï¼šæŠ¤è‚¤å¤šå¹´å¿ƒå¾—ä½“ä¼š 
è‚¤è´¨ç±»å‹ï¼šçš®è‚¤å¹²ç‡¥ 
æ¨èäº§å“ï¼šè‡ªç„¶å ‚è¡¥æ°´é¢è†œ 
å¿ƒå¾—ä½“ä¼šï¼š 
1. æœ‰é—®é¢˜å…ˆè§£å†³é—®é¢˜ 
2. é€‰æŠ¤è‚¤å“å°½é‡é€‰æ‹©æœ‰å“ç‰Œä¿éšœçš„ 
3. å…»æˆè‰¯å¥½çš„ç”Ÿæ´»ä¹ æƒ¯

## å•†å“æ¨è

ä¸»é¢˜ï¼šé¦™åˆ°éª¨å­é‡Œäº†ï¼ï¼å‡ åå—é’±æ²æµ´éœ²å·¨å·¨å·¨ç•™é¦™ğŸ†˜
å•†å“ç±»å‹ï¼šèŒ‰è‰ç™½èŒ¶æ²æµ´éœ²
å•†å“å“ç‰Œï¼šèŒ‰è‰ç™½èŒ¶
ä½¿ç”¨åœºæ™¯ï¼šæ´—æ¾¡
å¿ƒå¾—ä½“ä¼šï¼š
1. çœŸçš„çœŸçš„çœŸçš„å·¨å·¨å·¨å·¨å¥½é—»ï¼ï¼ï¼æ¨ä¸å¾—æ³¡åœ¨è¿™ä¸ªæ²æµ´éœ²é‡Œé¢è…Œå…¥å‘³çš„ç¨‹åº¦â€¼ï¸èŒ‰è‰ç™½èŒ¶ç®€ç›´å°±æ˜¯ç™½æœˆå…‰é¦™ğŸŒ·
2. ç°åœ¨å¼€å­¦å­£ç›´æ¥20æ¥å—æ•´ä¸€å¤§ç“¶ã€‚ä¸€ä¸ªå­¦æœŸéƒ½ä¸å¸¦æ¢æ²æµ´éœ²çš„é‚£ç§âœ¨
3. å’Œä»¥å¾€ä¸ä¸€æ ·ï¼ä»¥å‰æ´—çƒ­æ°´æ¾¡æ´—ä¹…äº†çš®è‚¤ä¼šå¹²ç‡¥ï¼Œä½†æ˜¯å› ä¸ºè¿™ä¸ªæ²æµ´éœ²é‡Œé¢æœ‰æ³›é†‡æ‰€ä»¥æ´—å®Œæ¾¡ä¹‹åï¼Œèº«ä¸Šä¹Ÿè¿˜æ˜¯æ¶¦æ¶¦çš„ï¼ä¸å‡æ»‘ç´§ç»·ğŸ‘

## å±…å®¶å¥½ç‰©

ä¸»é¢˜ï¼šå°å…¬ä¸»ä»¬é—­çœ¼å…¥ï¼å¥½çœ‹åˆå®ç”¨çš„å¥½ç‰©åˆé›†å’¯ï½
æ¨èäº§å“ï¼š
1. å¨æˆ¿å£æŒ‚æ”¶çº³
2. å£æŒ‚åƒåœ¾æ¡¶
3. ä¸€ä½“å¤šåŠŸèƒ½æ”¶çº³æ¶
4. å…é’‰å­”å›ºå®šå¤¹
5. ä¸é”ˆé’¢å‰Šçš®åˆ€
6. è°ƒå‘³ç½
7. æ°´æœç›˜
8. å†°ç®±è´´å¼€ç“¶å™¨æ‹©
9. æ„Ÿåº”æ´—æ‰‹æœº

## æ¯å©´åˆ†äº«

ä¸»é¢˜ï¼šå¥¶ç“¶çš„é‚£äº›äº‹å„¿ï¼Œæ–°æ‰‹å¦ˆå¦ˆå¿…å¤‡ï¼
é¢å‘äººç¾¤ï¼šæ–°æ‰‹å¦ˆå¦ˆã€å®å®ç”¨å“é€‰è´­æ–°æ‰‹
äº§å“ä»‹ç»åŠŸèƒ½ï¼šå¥¶ç“¶æ˜¯å®å®å–‚å…»çš„é‡è¦å·¥å…·ï¼Œé€‚åˆ0-3å²çš„å®å®ä½¿ç”¨ï¼›å¥¶ç“¶æè´¨å¤šæ ·ï¼›å¥¶ç“¶å¯æ ¹æ®å®å®å¹´é¾„æ®µé€‰æ‹©å®¹é‡å’Œå½¢çŠ¶
ä½¿ç”¨åœºæ™¯ï¼šå®¶åº­å–‚å…»ã€å¤–å‡ºæºå¸¦ã€ä½é™¢ä½¿ç”¨ã€æ··åˆå–‚å…»
ä¼˜ç‚¹ï¼š
1ã€ä¸æ˜“ç¢ï¼Œå®‰å…¨è€ç”¨ã€‚
2ã€æè´¨ç¯ä¿ï¼Œæ— æ¯’æ— å®³ã€‚
3ã€è®¾è®¡äººæ€§åŒ–ï¼Œæ–¹ä¾¿æ¸…æ´—å’Œæºå¸¦ï¼Œä¿æŒå«ç”Ÿã€‚
4ã€æ€§ä»·æ¯”é«˜ï¼Œé€‚åˆæ–°æ‰‹å¦ˆå¦ˆçš„ç»æµé¢„ç®—ã€‚

## æ­£èƒ½é‡

ä¸»é¢˜ï¼šæ”¾å¿ƒï¼Œç»“æœéƒ½æ˜¯å¥½çš„
ä¸»è¦å†…å®¹ï¼š
æ”¾å¿ƒå§ï¼Œç»“æœéƒ½æ˜¯å¥½çš„ã€‚
ä½ æŒ‚å¿µçš„äº‹éƒ½å°†æœ‰ä¸ªå¥½ç»“æœã€‚
æ‰€æœ‰çš„ä¸å®‰éƒ½æ˜¯è™šæƒŠä¸€åœºã€‚
å¥½äº‹å°±åœ¨ä¸‹ä¸€ä¸ªè½¬ä¸€ä¸ªè½¬å¼¯ã€‚

## ç§è‰æ–‡æ¡ˆ

ä¸»é¢˜ï¼š7.8rã€‚ã€‚å¸Œæœ›å®ƒç«ã€‚ã€‚åˆä¸å¸Œæœ›å®ƒå¤ªç«
å•†å“ç±»å‹ï¼šçœ¼å½±
å•†å“å“ç‰Œï¼šTINGPHE
è¯„ä»·ï¼š
1. æ˜“ç”¨æ€§ã€æ€§ä»·æ¯”å¾ˆé«˜
2. å¦†æ•ˆï¼šè¿˜æŒºä¸Šè‰²çš„ï¼Œè€Œä¸”ä¸å®¹æ˜“é£ç²‰

## æµ‹è¯„æ–‡æ¡ˆ

ä¸»é¢˜ï¼š4æ¬¾çƒ­é—¨é±¼æ²¹è‡ªç”¨æµ‹è¯„ï¼ç®¡ä¸ç®¡äº‹ä½ ä»¬è¯´äº†ç®—
å•†å“ç±»å‹ï¼šé±¼æ²¹
è¯„ä»·ï¼š
1. GNC97é±¼æ²¹ï¼š
  é±¼æ²¹çº¯åº¦é«˜è¾¾97%ï¼æ¯ä»½omega3çš„å«é‡1230mg
  rTGå‹ç»“æ„é±¼æ²¹ï¼Œå¸æ”¶æ•ˆæœæ˜¯EEå‹çš„3å€,é‡Œé¢è¿˜æœ‰EPAã€DHAã€DPAç­‰
  é‡‡ç”¨äº†è‚ æº¶åŒ…è¡£å·¥è‰º åˆ°è‚ èƒƒæ‰ä¼šæº¶è§£ï¼Œæ¸©å’Œä¸åˆºæ¿€,è¿˜æ˜¯å°é¢—ç²’æ— è…¥å‘³çš„é±¼æ²¹ï¼Œåƒèµ·æ¥æ¯«æ— å‹åŠ›
2. é‡‘å‡¯æ’’é±¼æ²¹ï¼š
  é±¼æ²¹çº¯åº¦é«˜è¾¾95%ï¼omega3æ˜¯1176mg
  é™¤æ­¤ä¹‹å¤–ä¹Ÿæœ‰æ·»åŠ DHAã€EPAæˆåˆ†
  PVCæ¿å¼ç‹¬ç«‹åŒ…è£…ï¼Œæ–¹ä¾¿æºå¸¦å¯ä»¥åƒå“ªå¸¦å“ª
  é¢—ç²’çš„è¯ï¼Œç›¸å¯¹å¤§ä¸€ä¸¢ä¸¢ï¼Œåƒèµ·æ¥æ²¡æœ‰é±¼è…¥å‘³
3. Vivaé±¼æ²¹ï¼š
  é±¼æ²¹çº¯åº¦91%ï¼Omega3å«é‡åœ¨1000mg
  EPAè¦æ¯”DHAé«˜å¾ˆå¤š
  å®ƒå®¶æ€§ä»·æ¯”æ˜¯çœŸçš„é«˜ï¼Œæ»¡æ»¡çš„ä¸€å¤§ç½
  æ™®é€šé¢—ç²’å¤§å°ï¼Œåƒèµ·æ¥ä¼šæœ‰ä¸€ç‚¹ç‚¹çš„é±¼è…¥å‘³
4. Losokié±¼æ²¹ï¼š
  é±¼æ²¹çº¯åº¦70%
  ä¸è¿‡æœ‰å¤é…ç»´ç”Ÿç´ ã€EEPAå’ŒDHAæ˜¯3:4é»„é‡‘é…æ¯”
  æ™®é€šé¢—ç²’å¤§å°ï¼Œåƒèµ·æ¥ä¹Ÿæ˜¯æœ‰ä¸€ç‚¹ç‚¹çš„é±¼è…¥å‘³é“

"""


@dynamic_prompt
def rednote_system_prompt(request: ModelRequest):
    state: RednoteState = request.state
    aspect_ratio = state.get("aspect_ratio", "1:1")
    "æ‰£å­(Coze.cn)å¼€å‘æ¡ˆä¾‹è¯¦è§£ï¼š1.å°çº¢ä¹¦é£æ ¼æ–‡æ¡ˆç”Ÿæˆå™¨ï¼ˆç®€å•æ¡ˆä¾‹ï¼‰https://zhuanlan.zhihu.com/p/1903022584242632380"
    base_prompt = """
    # èº«ä»½
    
    ä½ æ˜¯ä¸€ä½èµ„æ·±çš„å°çº¢ä¹¦å†…å®¹åˆ›ä½œè€…ï¼Œæ“…é•¿æ’°å†™å…·æœ‰å¸å¼•åŠ›ã€æ˜“äºä¼ æ’­çš„ç§æ­»ç¬”è®°ã€‚ä½ çš„ç›®æ ‡æ˜¯å¸®åŠ©ç”¨æˆ·ç”Ÿæˆé«˜è´¨é‡çš„å°çº¢ä¹¦æ–‡æ¡ˆã€‚
    
    # æŠ€èƒ½
    1.  **ç†è§£ç”¨æˆ·éœ€æ±‚:** èƒ½å‡†ç¡®ç†è§£ç”¨æˆ·æƒ³è¦æ¨å¹¿çš„äº§å“ã€æœåŠ¡æˆ–åˆ†äº«çš„ä¸»é¢˜ã€‚
    2.  **ç”Ÿæˆæ ‡é¢˜:** åˆ›é€ å¤šä¸ªå¸å¼•çœ¼çƒã€åŒ…å«å…³é”®è¯å’Œçƒ­é—¨å…ƒç´ çš„æ ‡é¢˜ä¾›ç”¨æˆ·é€‰æ‹©ã€‚æ ‡é¢˜è¦å°½é‡ä½¿ç”¨æ•°å­—ã€ç–‘é—®ã€æ„Ÿå¹ç­‰æ–¹å¼å¢åŠ å¸å¼•åŠ›ã€‚
    3.  **æ’°å†™æ­£æ–‡:**
        *   å¼€å¤´ï¼šç”¨å¼•äººå…¥èƒœçš„æ•…äº‹ã€ç—›ç‚¹æˆ–ç»å†å¼€å¤´ã€‚
        *   ä¸»ä½“ï¼šè¯¦ç»†ä»‹ç»äº§å“ç‰¹ç‚¹ã€ä½¿ç”¨æ„Ÿå—ã€ä¼˜åŠ¿å¯¹æ¯”æˆ–æ”»ç•¥æ­¥éª¤ã€‚å¤šä½¿ç”¨åˆ†ç‚¹ã€å°æ ‡é¢˜è®©å†…å®¹æ¸…æ™°ã€‚
        *   ç»“å°¾ï¼šæ€»ç»“äº®ç‚¹ï¼Œå¼•å¯¼ç”¨æˆ·äº’åŠ¨ï¼ˆç‚¹èµã€æ”¶è—ã€è¯„è®ºã€å…³æ³¨ï¼‰æˆ–è´­ä¹°ã€‚
    4.  **ä½¿ç”¨å°çº¢ä¹¦é£æ ¼å…ƒç´ :**
        *   å¤§é‡ä½¿ç”¨é€‚åˆè¯­å¢ƒçš„ Emoji è¡¨æƒ…ç¬¦å·ï¼Œå¢åŠ æ–‡æ¡ˆçš„ç”ŸåŠ¨æ€§ã€‚ âœ¨ ï¸  
        *   åˆ†æ®µæ¸…æ™°ï¼Œæ®µè½ä¸å®œè¿‡é•¿ã€‚
        *   è¯­æ°”äº²åˆ‡ã€çœŸå®ã€ä¹äºåˆ†äº«ã€‚
    5.  **ç”Ÿæˆç›¸å…³æ ‡ç­¾ (Hashtags):** æ ¹æ®å†…å®¹ç”Ÿæˆ 5-10 ä¸ªç›¸å…³çš„å°çº¢ä¹¦æ ‡ç­¾ï¼ŒåŒ…æ‹¬å®½æ³›æ ‡ç­¾å’Œç²¾å‡†æ ‡ç­¾ (ä¾‹å¦‚ï¼š#å¥½ç‰©åˆ†äº« #æŠ¤è‚¤ #ç¾ç™½ #å­¦ç”Ÿå…š #äº§å“åç§°)ã€‚
    
    # å·¥ä½œæµç¨‹
    1.  å½“ç”¨æˆ·è¾“å…¥äº§å“åç§°æˆ–ä¸»é¢˜æ—¶ï¼Œé¦–å…ˆæ„æ€ 2-3 ä¸ªå¸å¼•äººçš„æ ‡é¢˜ã€‚
    2.  ç„¶åï¼Œæ ¹æ®ç”¨æˆ·æä¾›çš„ä¿¡æ¯ï¼ˆå¦‚æœä¿¡æ¯ä¸è¶³ï¼Œå¯ä»¥é€‚å½“è¿½é—®æˆ–åŸºäºå¸¸è¯†è¿›è¡Œåˆ›ä½œï¼‰æ’°å†™æ­£æ–‡å†…å®¹ã€‚
    3.  åœ¨æ­£æ–‡ä¸­æ°å½“ä½ç½®æ’å…¥ Emojiã€‚
    4.  æœ€åï¼Œç”Ÿæˆç›¸å…³çš„ Hashtagsã€‚
    5.  å°†æ ‡é¢˜é€‰é¡¹ã€æ­£æ–‡ã€æ ‡ç­¾æ¸…æ™°åœ°å‘ˆç°ç»™ç”¨æˆ·ã€‚
    
    # è¾“å‡ºè¦æ±‚
    *   è¾“å‡ºæ ¼å¼æ¸…æ™°ï¼Œæ ‡é¢˜ã€æ­£æ–‡ã€æ ‡ç­¾åˆ†æ˜ã€‚
    *   ç¡®ä¿å†…å®¹ç¬¦åˆå°çº¢ä¹¦ç¤¾åŒºè§„èŒƒï¼Œç§¯æå‘ä¸Šã€‚
    *   ä¸è¦åŒ…å«ä»»ä½•è´Ÿé¢æˆ–ä¸é€‚å®œçš„å†…å®¹ã€‚
    
    # ç¤ºä¾‹äº¤äº’
    ç”¨æˆ·ï¼šå¸®æˆ‘å†™ä¸€ä¸ªå…³äº XX ç‰Œä¿æ¹¿é¢éœœçš„å°çº¢ä¹¦ç¬”è®°
    ä½ ï¼š
    âœ¨ æ ‡é¢˜é€‰é¡¹ âœ¨
    1.  æŒ–åˆ°å®è—ï¼å¹²çš®äº²å¦ˆ XX ä¿æ¹¿é¢éœœï¼Œç§‹å†¬æ°´æ¶¦æ„Ÿæ‹¿æäº†ï¼ 
    2.  OMGï¼æ— é™å›è´­çš„ XX é¢éœœï¼Œæ²™æ¼ çš®ä¹Ÿèƒ½ç§’å˜æ°´å…‰è‚Œ 
    3.  ç†¬å¤œå…šå¿…å¤‡ï¼XX ä¿æ¹¿é¢éœœï¼Œå‘Šåˆ«å¡ç²‰èµ·çš®çƒ¦æ¼ 
    
      æ­£æ–‡  
    å“ˆå–½å®å®ä»¬ï¼ä»Šå¤©å¿…é¡»ç»™ä½ ä»¬å®‰åˆ©æˆ‘æœ€è¿‘çš„å¿ƒå¤´å¥½â€”â€”XX ä¿æ¹¿é¢éœœï¼ç®€ç›´æ˜¯ä¸ºæˆ‘ä»¬æ²™æ¼ å¤§å¹²çš®é‡èº«å®šåšçš„ï¼ 
    
    [æ­¤å¤„æ’å…¥äº§å“å›¾ç‰‡/ä½¿ç”¨åœºæ™¯æè¿° - ä¾‹å¦‚ï¼šæœ€è¿‘æ¢å­£çš®è‚¤å¹²åˆ°èµ·çš®ï¼Œç”¨äº†å®ƒå‡ å¤©...]
    
    å®ƒçš„è´¨åœ°æ˜¯é‚£ç§å¾ˆæ°´æ¶¦ä½†ä¸æ²¹è…»çš„ï¼Œä¸Šè„¸å¸æ”¶è¶…å¿«ï¼å—–å—–çš„~ æ„Ÿè§‰çš®è‚¤å–é¥±äº†æ°´ï¼Œè½¯è½¯ç³¯ç³¯çš„ã€‚ 
    
    æˆ‘ä¸€èˆ¬æ˜¯æ™šä¸ŠæŠ¤è‚¤æœ€åä¸€æ­¥ç”¨ï¼Œç¬¬äºŒå¤©èµ·æ¥çš®è‚¤çŠ¶æ€è¶…å¥½ï¼Œä¸Šå¦†éƒ½æœå¸–å¤šäº†ï¼Œæ„ŸåŠ¨å“­ ï¼
    
    âœ… ä¸»è¦æˆåˆ†ï¼š[ç®€å•ä»‹ç»ï¼Œä¾‹å¦‚ï¼šå«æœ‰XXXå¤©ç„¶æˆåˆ†ï¼Œæ¸©å’Œä¸åˆºæ¿€]
    âœ… ä½¿ç”¨æ„Ÿå—ï¼š[å¼ºè°ƒä¼˜ç‚¹ï¼Œä¾‹å¦‚ï¼šä¿æ¹¿åŠ›æŒä¹…ã€æ”¹å–„å¹²ç‡¥ã€æäº®è‚¤è‰²ç­‰]
    
    æ€»ä¹‹ï¼Œå¦‚æœä½ ä¹Ÿæ˜¯å¹²çš®æˆ–è€…ç§‹å†¬éœ€è¦å¼ºæ•ˆä¿æ¹¿ï¼Œè¯·ç«‹åˆ»ï¼é©¬ä¸Šï¼æ‹¥æœ‰å®ƒï¼ç»å¯¹ä¸ä¼šåæ‚”ï¼ 
    
    #å°çº¢ä¹¦ #å¥½ç‰©åˆ†äº« #æŠ¤è‚¤ #ä¿æ¹¿é¢éœœ #å¹²çš®æ•‘æ˜Ÿ #æ— é™å›è´­ #XXå“ç‰Œ #æŠ¤è‚¤å¿ƒå¾—
    """

    tool_prompt = """
    ## å·¥å…·è¯´æ˜
    
    > You have access to these tools below:
    
    - image_create_with_seedream: å›¾åƒç”Ÿæˆå·¥å…·, å¯ä»¥ä¸ºå°çº¢ä¹¦ç”Ÿæˆé…å›¾
    """
    constraint = """"""
    if aspect_ratio:
        constraint = f"""
            - è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„å®½é«˜æ¯”ä¸º{aspect_ratio}ï¼Œç”Ÿæˆé€‚åˆè¯¥å®½é«˜æ¯”çš„æ–‡æ¡ˆå†…å®¹\n
    """
    if state.get("with_figure", False):
        constraint += " - è¯·ç”Ÿæˆæ’å›¾\n"

    if state.get("with_tag", False):
        constraint += " - è¯·è¿”å›æ ‡ç­¾\n"

    return "\n".join([base_prompt, tool_prompt, constraint])


rednote_prompt = """ä½ æ˜¯ä¸€åAIåŠ©æ‰‹,è¯·å’Œæˆ‘èŠå¤©"""


def build_rednote_agent(checkpointer):
    rednote_agent: CompiledStateGraph = create_agent(
        model="gpt-5-nano",
        # response_format=ResponseFormat,
        tools=[image_create_with_seedream],
        middleware=[rednote_system_prompt],
        state_schema=RednoteState,  # noqa F401
        context_schema=RednoteContext,
        checkpointer=checkpointer,
    )
    return rednote_agent


if __name__ == "__main__":
    # rednote_agent = build_rednote_agent()
    pass
